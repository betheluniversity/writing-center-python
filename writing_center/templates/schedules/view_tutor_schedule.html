{% extends 'schedules/base.html' %}

{% block body_content %}
    <div class="jumbotron">
        <h1><b>View Tutor Schedule</b></h1>
        <p>Displays the appointments a tutor is assigned to.</p>
    </div>
    <div class="row">
        <div class="col-md-3">
            <div id="tutors">
                <h3>Tutors</h3>
                <select id="tutors-schedule" class="chosen-container" size="7" multiple="multiple" onchange="tutorsChanged()">
                    <option id="view-all" class="select-hr" value="View All">View All Schedules</option>
                    {% for tutor in tutors %}
                        <option id="{{ tutor.id }}" value="{{ tutor.id }}">{{ tutor.firstName }} {{ tutor.lastName }}</option>
                    {% endfor %}
                </select>
                <hr>
            </div>
            <h3>Calendar Key</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Color</th>
                        <th>Meaning</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="calendar-blue">Blue</td>
                        <td>General Appointment</td>
                    </tr>
                    <tr>
                        <td class="calendar-orange">Orange</td>
                        <td>Open Multilingual Appointment</td>
                    </tr>
                    <tr>
                        <td class="calendar-green">Green</td>
                        <td>Drop-in Hours</td>
                    </tr>
                </tbody>
            </table>
        </div>
        {# spinner placeholder #}
        <div id="spinner" class="spinner" style="display: none;margin-top: -300px;">
            <img id="img-spinner" class="spinner-img" src="https://cdn1.bethel.edu/images/load.gif" alt="Loading"/>
        </div>
        <div class="col-md-9">
            <div id="calendar"></div>
        </div>
    </div>
    <hr>
    <div class="jumbotron">
        <h1><b>Delete Tutor Shifts</b></h1>
        <p>Delete all appointments for the selected tutor in the given date range.</p>
    </div>
    <div class="form-row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="start-date">Start Date</label>
                <input class="form-control datepicker" id="start-date" type="text" readonly/>
                <div id="start-container"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="end-date">End Date</label>
                <input class="form-control datepicker" id="end-date" type="text" readonly/>
                <div id="end-container"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <select id="tutors-shifts" class="chosen-container" size="7" multiple="multiple">
                    <option id="view-all" class="select-hr" value="View All" selected="selected">Select All Tutors</option>
                    {% for tutor in tutors %}
                        <option id="{{ tutor.id }}" value="{{ tutor.id }}">{{ tutor.firstName }} {{ tutor.lastName }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div id="delete-confirm" class="form-row">
        <input type="button" id="delete-shifts" class="btn btn-primary btn-danger" value="Delete Shifts" onclick="confirmDelete()">
    </div>
    <div id="sub-list-results" class="form-row"></div>
    <script>
        $(document).ready(function () {
            $('.datepicker').each(function () {
                let current_element = $(this);
                let maxDate = new Date();
                let dd = maxDate.getDate();
                let mm = maxDate.getMonth() + 1;
                let yyyy = maxDate.getFullYear() + 2;
                if (dd < 10) {
                  dd = '0' + dd;
                }

                if (mm < 10) {
                  mm = '0' + mm;
                }
                maxDate = yyyy + '-' + mm + '-' + dd;
                let starting_values = {
                    field: this,
                    format: 'MM DD YYYY',
                    minDate: new Date('2010-01-01'),
                    maxDate: new Date(maxDate),
                    yearRange: [2010, yyyy],
                    disableDayFn: function (date) {
                        let start_populated = $("#start-date").val();
                        let end_populated = $("#end-date").val();
                        if (start_populated == "") {
                            return null;
                        } else if (current_element.attr('id') == 'start-date') {
                            if (new Date(end_populated) > date) {
                                return date;
                            }
                        } else if (current_element.attr('id') == 'end-date') {
                            if (new Date(end_populated) > date) {
                                return date;
                            }
                        }
                    }
                };
                let timeSetting = ({{ time_setting }});
                starting_values['defaultDate'] = new Date(new Date().getTime() + timeSetting * 60 * 60 * 1000);
                starting_values['setDefaultDate'] = true;
                let picker = new Pikaday(starting_values);
            });
        });
        let calendarEl = document.getElementById('calendar');

        let calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid', 'timeGrid'],
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            slotEventOverlap: false,
            nowIndicator: true,
            displayEventEnd: true,
        });

        calendar.render();

        function tutorsChanged() {
            $('#spinner').show();
            let tutors = [];
            $("#tutors-schedule option:selected").each(function() {
                tutors.push(this.id);
            });
            $.ajax({
                type: "POST",
                url: "{{ url_for('SchedulesView:show_tutor_schedule') }}",
                data: JSON.stringify({
                    'tutors': tutors,
                }),
                contentType: 'application/json;charset=UTF-8',
                success: function (response) {
                    calendar.removeAllEvents();
                    let i = 0;
                    calendar.batchRendering(function() {
                        for (i; i < response.length; i++) {
                            calendar.addEvent({
                                title: response[i].tutor_id,
                                start: response[i].startTime,
                                end: response[i].endTime
                            });
                        }
                    });
                    $('#spinner').hide();
                },
                error: function (error) {

                }
            });
        }

        function confirmDelete() {
            let startDate = $('#start-date').val();
            let endDate = $('#end-date').val();
            let tutors = [];
            $("#tutors-shifts option:selected").each(function() {
                tutors.push(this.id);
            });
            $.ajax({
                type: "POST",
                url: "{{ url_for('SchedulesView:confirm_delete') }}",
                data: JSON.stringify({
                    'tutors': tutors,
                    'startDate': startDate,
                    'endDate': endDate
                }),
                contentType: 'application/json;charset=UTF-8',
                success: function (data) {
                    $('#delete-confirm').html(data)
                },
                error: function (error) {

                }
            });
        }

        function confirmedNo() {
            $('#delete-confirm').html("<input type=\"button\" id=\"delete-shifts\" class=\"btn btn-primary btn-danger\" value=\"Delete Shifts\" onclick=\"confirmDelete()\">")
            $('#sub-list-results').html("")
        }

        function deleteShifts() {
            let startDate = $('#start-date').val();
            let endDate = $('#end-date').val();
            let tutors = [];
            $("#tutors-shifts option:selected").each(function() {
                tutors.push(this.id);
            });
             $.ajax({
                type: "POST",
                url: "{{ url_for('SchedulesView:delete_tutors_from_shifts') }}",
                data: JSON.stringify({
                    'tutors': tutors,
                    'startDate': startDate,
                    'endDate': endDate
                }),
                contentType: 'application/json;charset=UTF-8',
                success: function (data) {
                    $('#delete-confirm').html("<input type=\"button\" id=\"delete-shifts\" class=\"btn btn-primary btn-danger\" value=\"Delete Shifts\" onclick=\"confirmDelete()\">")
                    $('#sub-list-results').html(data)
                },
                error: function (error) {

                }
            });
        }
    </script>
{% endblock %}